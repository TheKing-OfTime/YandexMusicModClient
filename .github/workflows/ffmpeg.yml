name: Build FFmpeg (manual)

on:
  workflow_dispatch:
    inputs:
      ffmpeg_ref:
        description: "Git ref/tag/branch for FFmpeg (e.g. n7.1.1, release/7.1, master)"
        required: false
        default: "n8.0.1"

concurrency:
  group: ffmpeg-build-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write

jobs:
  build:
    name: ${{ matrix.name }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: linux-x86_64
            runner: ubuntu-latest
            target: linux
            arch: x86_64
            cross: false

          - name: macos-x86_64
            runner: macos-15-intel
            target: macos
            arch: x86_64
            cross: false

          - name: macos-arm64
            runner: macos-latest
            target: macos
            arch: arm64
            cross: false

          - name: windows-x86_64
            runner: ubuntu-latest
            target: windows
            arch: x86_64
            cross: true

    runs-on: ${{ matrix.runner }}

    env:
      LLVM_MINGW_TAG: "20251216"
      LLVM_MINGW_BASEURL: "https://github.com/mstorsjo/llvm-mingw/releases/download"

    steps:
      - uses: actions/checkout@v4

      - name: Install deps (Ubuntu)
        if: runner.os == 'Linux'
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            build-essential pkg-config yasm nasm autoconf automake libtool \
            cmake git curl xz-utils ca-certificates

      - name: Install deps (macOS)
        if: runner.os == 'macOS'
        run: |
          set -euo pipefail
          brew update
          brew install pkg-config yasm nasm

      - name: Fetch FFmpeg source
        run: |
          set -euo pipefail
          rm -rf ffmpeg
          git clone --depth 1 --branch "${{ inputs.ffmpeg_ref }}" \
            https://git.ffmpeg.org/ffmpeg.git ffmpeg

      - name: Setup llvm-mingw (Windows cross)
        if: matrix.cross == true
        run: |
          set -euo pipefail
          TARBALL="llvm-mingw-${LLVM_MINGW_TAG}-ucrt-ubuntu-22.04-x86_64.tar.xz"
          curl -L -o "${TARBALL}" \
            "${LLVM_MINGW_BASEURL}/${LLVM_MINGW_TAG}/${TARBALL}"
          mkdir llvm-mingw
          tar -xJf "${TARBALL}" -C llvm-mingw --strip-components=1
          echo "${PWD}/llvm-mingw/bin" >> "${GITHUB_PATH}"

      - name: Build + Install
        run: |
          set -euo pipefail
          cd ffmpeg
          mkdir -p "${GITHUB_WORKSPACE}/dist"

          if [ "${{ matrix.cross }}" = "true" ]; then
            HOST=x86_64-w64-mingw32
            export CC="${HOST}-clang"
            export CXX="${HOST}-clang++"
            export AR="${HOST}-ar"
            export RANLIB="${HOST}-ranlib"
            export STRIP="${HOST}-strip"
            export NM="${HOST}-nm"

            ./configure \
              --prefix="${GITHUB_WORKSPACE}/dist" \
              --target-os=mingw32 \
              --arch=x86_64 \
              --enable-cross-compile \
              --disable-ffprobe
          else
            ./configure \
              --prefix="${GITHUB_WORKSPACE}/dist" \
              --disable-ffprobe
          fi

          make -j"$(getconf _NPROCESSORS_ONLN)"
          make install

      - name: Package artifact (tar.gz)
        run: |
          set -euo pipefail
          mkdir -p out
          ART="ffmpeg-${{ matrix.target }}-${{ matrix.arch }}"
          BIN="dist/bin/ffmpeg"
          [ "${{ matrix.target }}" = "windows" ] && BIN="${BIN}.exe"

          sha256sum "${BIN}" | awk '{print $1}' > "out/${ART}.sha256"
          tar -C dist/bin -czf "out/${ART}.tar.gz" "$(basename "${BIN}")"

      - uses: actions/upload-artifact@v4
        with:
          name: ffmpeg-${{ matrix.target }}-${{ matrix.arch }}
          path: out/*

  release:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@v4

      - uses: softprops/action-gh-release@v2
        with:
          tag_name: ffmpeg-binaries
          name: FFmpeg prebuilt binaries
          files: |
            ffmpeg-*/ffmpeg-*.tar.gz
            ffmpeg-*/ffmpeg-*.sha256
