name: Build FFmpeg (manual)

on:
  workflow_dispatch:
    inputs:
      ffmpeg_ref:
        description: "FFmpeg git ref (tag/commit/branch). Например: n6.1.1"
        required: false
        default: "n6.1.1"

permissions:
  contents: write

concurrency:
  group: ffmpeg-build-${{ github.ref }}
  cancel-in-progress: false

env:
  # Под ваш реальный кейс:
  # 1) input: MP4/MOV (mov demuxer)
  # 2) cover: JPEG как attached_pic:
  #    - image2 demuxer (чтение 400x400.jpg)
  #    - mjpeg decoder (прочитать JPEG)
  #    - mjpeg encoder (записать attached_pic)
  # 3) output: MP4/MOV/IPOD + MP3/FLAC
  # 4) mp3 encode: libmp3lame (как в вашем JS: -codec:a libmp3lame)
  # 5) decode аудио из MP4 для mp3-конвертации: aac/alac/flac/mp3/opus/vorbis/pcm_s16le
  #
  # Важно: НЕ используем --disable-programs (чтобы гарантированно собрать ffmpeg),
  # а просто выключаем лишние программы.
  FFMPEG_CONFIG_FLAGS: >-
    --disable-everything
    --enable-ffmpeg
    --disable-ffprobe
    --disable-ffplay
    --enable-avcodec
    --enable-avformat
    --enable-avutil
    --enable-swresample
    --enable-protocol=file,pipe
    --enable-demuxer=mov,image2
    --enable-muxer=mp4,mov,ipod,mp3,flac
    --enable-decoder=aac,alac,flac,mp3,opus,vorbis,pcm_s16le,mjpeg
    --enable-encoder=libmp3lame,mjpeg,flac,aac
    --enable-parser=aac,flac,mp3,opus,vorbis
    --enable-libmp3lame
    --enable-bsf=aac_adtstoasc
    --disable-doc
    --disable-debug
    --disable-network
    --disable-autodetect
    --enable-small

jobs:
  build:
    name: Build (${{ matrix.target }})
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            target: linux-x64
          - os: windows-latest
            target: win-x64
          - os: macos-15-intel
            target: macos-x64
          - os: macos-latest
            target: macos-arm64

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # ---------- deps ----------
      - name: Install deps (Linux)
        if: runner.os == 'Linux'
        shell: bash
        run: |
          set -euo pipefail
          sudo apt update
          sudo apt install -y \
            yasm nasm pkg-config build-essential git curl zip \
            libmp3lame-dev

      - name: Install deps (macOS)
        if: runner.os == 'macOS'
        shell: bash
        run: |
          set -euo pipefail
          brew update
          brew install yasm nasm pkg-config lame zip

      - name: Setup MSYS2 (Windows)
        if: runner.os == 'Windows'
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: >-
            mingw-w64-x86_64-toolchain
            mingw-w64-x86_64-yasm
            mingw-w64-x86_64-nasm
            mingw-w64-x86_64-pkgconf
            mingw-w64-x86_64-lame
            make
            git
            zip
            curl

      # ---------- source ----------
      - name: Clone FFmpeg
        shell: bash
        run: |
          set -euo pipefail
          git clone --depth 1 --branch "${{ github.event.inputs.ffmpeg_ref }}" https://github.com/FFmpeg/FFmpeg.git

      # ---------- configure/build ----------
      - name: Configure (Linux/macOS)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          set -euo pipefail
          cd FFmpeg

          ./configure \
            $FFMPEG_CONFIG_FLAGS \
            --disable-shared \
            --enable-static \
            --pkg-config-flags="--static"

          echo "=== Programs (sanity) ==="
          # Показываем, что ffmpeg включён
          grep -E "Programs:|ffmpeg" -n config.log || true

      - name: Configure (Windows / MSYS2)
        if: runner.os == 'Windows'
        shell: msys2 {0}
        run: |
          set -euo pipefail
          cd FFmpeg

          ./configure \
            $FFMPEG_CONFIG_FLAGS \
            --disable-shared \
            --enable-static \
            --pkg-config-flags="--static"

          echo "=== Programs (sanity) ==="
          grep -E "Programs:|ffmpeg" -n config.log || true

      - name: Build (Linux/macOS)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          set -euo pipefail
          cd FFmpeg
          make -j"$(nproc 2>/dev/null || sysctl -n hw.ncpu)"

          # Жёсткая проверка, чтобы сразу увидеть проблему
          test -f ffmpeg

      - name: Build (Windows / MSYS2)
        if: runner.os == 'Windows'
        shell: msys2 {0}
        run: |
          set -euo pipefail
          cd FFmpeg
          make -j"$(nproc)"

          test -f ffmpeg.exe

      # ---------- strip ----------
      - name: Strip (Linux/macOS)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          set -euo pipefail
          cd FFmpeg
          strip ffmpeg || true

      - name: Strip (Windows / MSYS2)
        if: runner.os == 'Windows'
        shell: msys2 {0}
        run: |
          set -euo pipefail
          cd FFmpeg
          x86_64-w64-mingw32-strip ffmpeg.exe || true

      # ---------- package ----------
      - name: Package (Linux/macOS)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p dist
          OUT="ffmpeg-${{ matrix.target }}"
          cp "FFmpeg/ffmpeg" "dist/${OUT}"
          chmod +x "dist/${OUT}"

          # sha256
          if command -v sha256sum >/dev/null 2>&1; then
            (cd dist && sha256sum "${OUT}" > "${OUT}.sha256")
          else
            (cd dist && shasum -a 256 "${OUT}" > "${OUT}.sha256")
          fi

          (cd dist && zip -9 "ffmpeg-${{ matrix.target }}.zip" "${OUT}" "${OUT}.sha256")

      - name: Package (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          New-Item -ItemType Directory -Force -Path dist | Out-Null
          $out = "ffmpeg-${{ matrix.target }}.exe"
          Copy-Item -Force "FFmpeg\ffmpeg.exe" "dist\$out"

          # sha256
          $hash = (Get-FileHash -Algorithm SHA256 "dist\$out").Hash.ToLower()
          "$hash  $out" | Out-File -Encoding ascii -NoNewline "dist\$out.sha256"

          # zip
          if (Test-Path "dist\ffmpeg-${{ matrix.target }}.zip") { Remove-Item -Force "dist\ffmpeg-${{ matrix.target }}.zip" }
          Compress-Archive -Path "dist\$out","dist\$out.sha256" -DestinationPath "dist\ffmpeg-${{ matrix.target }}.zip" -Force

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ffmpeg-${{ matrix.target }}
          path: dist/ffmpeg-${{ matrix.target }}.zip
          if-no-files-found: error
          retention-days: 14

  release:
    name: Publish release assets
    needs: build
    runs-on: ubuntu-latest

    steps:
      - uses: actions/download-artifact@v4

      - name: Create / update release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ffmpeg-binaries
          name: FFmpeg prebuilt binaries
          prerelease: false
          make_latest: false
          fail_on_unmatched_files: true
          files: |
            ffmpeg-*/ffmpeg-*.zip
