name: Build FFmpeg (self-contained)

on:
  workflow_dispatch:
    inputs:
      ffmpeg_ref:
        description: "Git ref/tag/branch for FFmpeg (e.g. n7.1.1, release/7.1, master)"
        required: false
        default: "n8.0.1"

concurrency:
  group: ffmpeg-build-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write

jobs:
  build:
    name: ${{ matrix.name }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux native (x86_64 only)
          - name: linux-x86_64
            runner: ubuntu-latest
            target: linux
            arch: x86_64
            cross: false

          # macOS native (arm64 + x86_64)
          - name: macos-x86_64
            runner: macos-15-intel
            target: macos
            arch: x86_64
            cross: false

          - name: macos-arm64
            runner: macos-latest
            target: macos
            arch: arm64
            cross: false

          # Windows via cross-compilation (x86_64 only)
          - name: windows-x86_64
            runner: ubuntu-latest
            target: windows
            arch: x86_64
            cross: true

    runs-on: ${{ matrix.runner }}

    env:
      # Pin llvm-mingw tag; update if you need newer toolchain
      LLVM_MINGW_TAG: "20251216"
      LLVM_MINGW_BASEURL: "https://github.com/mstorsjo/llvm-mingw/releases/download"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install deps (Ubuntu)
        if: runner.os == 'Linux'
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            build-essential \
            pkg-config \
            yasm \
            nasm \
            autoconf \
            automake \
            libtool \
            cmake \
            git \
            curl \
            xz-utils \
            ca-certificates \
            libxml2-dev \
            libssl-dev \
            zlib1g-dev \
            libmp3lame-dev \
            libopus-dev \
            libvorbis-dev \
            libtheora-dev \
            libvpx-dev \
            libx264-dev \
            libx265-dev \
            libfreetype6-dev \
            libfontconfig1-dev \
            libfribidi-dev \
            libass-dev \
            libwebp-dev

      - name: Install deps (macOS)
        if: runner.os == 'macOS'
        run: |
          set -euo pipefail
          brew update
          brew install pkg-config yasm nasm libxml2 openssl zlib \
            lame opus libvorbis theora libvpx x264 x265 freetype \
            fontconfig libfribidi libass webp

      - name: Fetch FFmpeg source
        run: |
          set -euo pipefail
          rm -rf ffmpeg
          git clone --depth 1 --branch "${{ inputs.ffmpeg_ref }}" https://git.ffmpeg.org/ffmpeg.git ffmpeg

      - name: Setup llvm-mingw (for Windows cross)
        if: matrix.cross == true
        run: |
          set -euo pipefail
          TARBALL="llvm-mingw-${LLVM_MINGW_TAG}-ucrt-ubuntu-22.04-x86_64.tar.xz"
          URL="${LLVM_MINGW_BASEURL}/${LLVM_MINGW_TAG}/${TARBALL}"
          echo "Downloading: ${URL}"
          curl -L --retry 5 --retry-delay 2 -o "${TARBALL}" "${URL}"
          rm -rf llvm-mingw
          mkdir -p llvm-mingw
          tar -xJf "${TARBALL}" -C llvm-mingw --strip-components=1
          echo "${PWD}/llvm-mingw/bin" >> "${GITHUB_PATH}"

      - name: Configure FFmpeg (native) - with audio/metadata codecs
        if: matrix.cross == false
        run: |
          set -euo pipefail
          cd ffmpeg
          mkdir -p "${GITHUB_WORKSPACE}/dist"
          
          ./configure \
            --prefix="${GITHUB_WORKSPACE}/dist" \
            --enable-gpl \
            --enable-libmp3lame \
            --enable-libopus \
            --enable-libvorbis \
            --enable-libtheora \
            --enable-libvpx \
            --enable-libx264 \
            --enable-libx265 \
            --enable-libfreetype \
            --enable-libfontconfig \
            --enable-libfribidi \
            --enable-libass \
            --enable-libwebp \
            --disable-ffprobe \
            --disable-ffplay \
            --disable-doc \
            --disable-htmlpages \
            --disable-manpages \
            --disable-podpages \
            --disable-txtpages \
            --disable-network \
            --disable-libxcb \
            --disable-xlib

      - name: Build + Install (native)
        if: matrix.cross == false
        run: |
          set -euo pipefail
          cd ffmpeg
          make -j"$(getconf _NPROCESSORS_ONLN)" 2>&1 | tail -50
          make install

      - name: Configure FFmpeg (Windows cross) - with audio/metadata codecs
        if: matrix.cross == true
        run: |
          set -euo pipefail
          cd ffmpeg
          mkdir -p "${GITHUB_WORKSPACE}/dist"

          HOST_TRIPLE="x86_64-w64-mingw32"
          FFMPEG_ARCH="x86_64"

          export CC="${HOST_TRIPLE}-clang"
          export CXX="${HOST_TRIPLE}-clang++"
          export AR="${HOST_TRIPLE}-ar"
          export RANLIB="${HOST_TRIPLE}-ranlib"
          export STRIP="${HOST_TRIPLE}-strip"
          export NM="${HOST_TRIPLE}-nm"

          ./configure \
            --prefix="${GITHUB_WORKSPACE}/dist" \
            --target-os=mingw32 \
            --arch="${FFMPEG_ARCH}" \
            --enable-cross-compile \
            --cc="${CC}" \
            --cxx="${CXX}" \
            --ar="${AR}" \
            --ranlib="${RANLIB}" \
            --strip="${STRIP}" \
            --nm="${NM}" \
            --enable-gpl \
            --enable-libmp3lame \
            --enable-libopus \
            --enable-libvorbis \
            --enable-libtheora \
            --enable-libvpx \
            --enable-libx264 \
            --enable-libx265 \
            --enable-libfreetype \
            --enable-libfontconfig \
            --enable-libfribidi \
            --enable-libass \
            --enable-libwebp \
            --disable-ffprobe \
            --disable-ffplay \
            --disable-doc \
            --disable-htmlpages \
            --disable-manpages \
            --disable-podpages \
            --disable-txtpages \
            --disable-network \
            --disable-libxcb \
            --disable-xlib

      - name: Build + Install (Windows cross)
        if: matrix.cross == true
        run: |
          set -euo pipefail
          cd ffmpeg
          make -j"$(getconf _NPROCESSORS_ONLN)" 2>&1 | tail -50
          make install

      - name: Verify binary
        run: |
          set -euo pipefail
          if [ "${{ matrix.target }}" = "windows" ]; then
            BIN="dist/bin/ffmpeg.exe"
          else
            BIN="dist/bin/ffmpeg"
          fi
          
          if [ ! -f "${BIN}" ]; then
            echo "ERROR: Binary not found at ${BIN}"
            ls -la dist/bin/
            exit 1
          fi
          
          echo "Binary size:"
          ls -lh "${BIN}"
          echo "Binary info:"
          file "${BIN}"

      - name: Strip binary (native only, not Windows cross)
        if: matrix.cross == false
        run: |
          set -euo pipefail
          if [ "${{ matrix.target }}" = "windows" ]; then
            BIN="dist/bin/ffmpeg.exe"
          else
            BIN="dist/bin/ffmpeg"
          fi
          strip -s "${BIN}" || true
          echo "After strip:"
          ls -lh "${BIN}"

      - name: Create distribution archive + sha256
        shell: bash
        run: |
          set -euo pipefail
          ARTIFACT="ffmpeg-${{ matrix.target }}-${{ matrix.arch }}"
          mkdir -p out

          if [ "${{ matrix.target }}" = "windows" ]; then
            BIN="dist/bin/ffmpeg.exe"
          else
            BIN="dist/bin/ffmpeg"
          fi

          if [ ! -f "${BIN}" ]; then
            echo "Expected binary not found: ${BIN}"
            exit 1
          fi

          TAR_PATH="out/${ARTIFACT}.tar.gz"
          SHA_PATH="out/${ARTIFACT}.sha256"

          # Calculate sha256 of the binary
          if command -v sha256sum >/dev/null 2>&1; then
            sha256sum "${BIN}" | awk '{print $1}' > "${SHA_PATH}"
          else
            shasum -a 256 "${BIN}" | awk '{print $1}' > "${SHA_PATH}"
          fi

          # Create tar.gz archive with the binary only
          tar -C "$(dirname "${BIN}")" -czf "${TAR_PATH}" "$(basename "${BIN}")"

          echo "=== Artifact Info ==="
          echo "Archive: ${TAR_PATH}"
          ls -lh "${TAR_PATH}"
          echo "SHA256: $(cat "${SHA_PATH}")"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ffmpeg-${{ matrix.target }}-${{ matrix.arch }}
          path: out/*
          if-no-files-found: error

  release:
    name: Publish release assets
    needs: build
    runs-on: ubuntu-latest

    steps:
      - uses: actions/download-artifact@v4

      - name: Create / update release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ffmpeg-binaries
          name: FFmpeg prebuilt binaries (self-contained)
          prerelease: false
          make_latest: false
          fail_on_unmatched_files: true
          files: |
            ffmpeg-*/ffmpeg-*.tar.gz
            ffmpeg-*/ffmpeg-*.sha256
