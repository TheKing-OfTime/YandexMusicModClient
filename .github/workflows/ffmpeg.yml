name: Build FFmpeg (manual)

on:
  workflow_dispatch:
    inputs:
      ffmpeg_ref:
        description: "FFmpeg git ref (tag/commit/branch). Например: n6.1.1"
        required: false
        default: "n6.1.1"

permissions:
  contents: write

concurrency:
  group: ffmpeg-build-${{ github.ref }}
  cancel-in-progress: false

env:
  # Полноценная конфигурация, без SVT-AV1 и без --enable-postproc
  # Лицензия:
  # --enable-gpl + libx264 => итоговый бинарник GPL.
  FFMPEG_CONFIG_FLAGS: >-
    --disable-debug
    --disable-doc
    --enable-stripping
    --enable-runtime-cpudetect
    --enable-pic
    --enable-ffmpeg
    --enable-ffprobe
    --enable-avcodec
    --enable-avformat
    --enable-avutil
    --enable-avfilter
    --enable-swresample
    --enable-swscale
    --enable-avdevice
    --enable-gpl
    --enable-version3
    --enable-libmp3lame
    --enable-libopus
    --enable-libvorbis
    --enable-libvpx
    --enable-libx264
    --enable-libaom
    --enable-libdav1d
    --enable-libass
    --enable-libfreetype
    --enable-libfribidi

jobs:
  build:
    name: Build (${{ matrix.target }})
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-22.04
            target: linux-x64
            artifact_ext: ""
          - os: windows-latest
            target: win-x64
            artifact_ext: ".exe"
          - os: macos-15-intel
            target: macos-x64
            artifact_ext: ""
          - os: macos-latest
            target: macos-arm64
            artifact_ext: ""

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # ---------- deps ----------
      - name: Install deps (Linux)
        if: runner.os == 'Linux'
        run: |
          set -euo pipefail
          sudo apt update
          sudo apt install -y \
            autoconf automake libtool cmake make pkg-config git \
            yasm nasm build-essential \
            zip \
            zlib1g-dev \
            libssl-dev \
            libmp3lame-dev \
            libopus-dev \
            libvorbis-dev \
            libvpx-dev \
            libx264-dev \
            libaom-dev \
            libdav1d-dev \
            libass-dev \
            libfreetype6-dev \
            libfribidi-dev

      - name: Install deps (macOS)
        if: runner.os == 'macOS'
        run: |
          set -euo pipefail
          brew update
          brew install \
            yasm nasm pkg-config cmake git \
            lame opus libvorbis libvpx x264 aom dav1d \
            libass freetype fribidi openssl@3 \
            zip

      - name: Setup MSYS2 (Windows)
        if: runner.os == 'Windows'
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: >-
            mingw-w64-x86_64-toolchain
            mingw-w64-x86_64-yasm
            mingw-w64-x86_64-nasm
            mingw-w64-x86_64-pkgconf
            mingw-w64-x86_64-cmake
            mingw-w64-x86_64-zlib
            mingw-w64-x86_64-openssl
            mingw-w64-x86_64-lame
            mingw-w64-x86_64-opus
            mingw-w64-x86_64-libvorbis
            mingw-w64-x86_64-libvpx
            mingw-w64-x86_64-x264
            mingw-w64-x86_64-aom
            mingw-w64-x86_64-dav1d
            mingw-w64-x86_64-libass
            mingw-w64-x86_64-freetype
            mingw-w64-x86_64-fribidi
            make
            git
            zip

      # ---------- source ----------
      - name: Clone FFmpeg (supports tag/branch/commit)
        shell: bash
        run: |
          set -euo pipefail
          REF="${{ github.event.inputs.ffmpeg_ref }}"
          echo "FFmpeg ref: $REF"

          git clone https://github.com/FFmpeg/FFmpeg.git
          cd FFmpeg
          git fetch --tags --force
          git checkout --force "$REF"
          git submodule update --init --recursive

      # ---------- configure/build ----------
      - name: Configure (Linux/macOS)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          set -euo pipefail
          cd FFmpeg

          EXTRA_CFLAGS=""
          EXTRA_LDFLAGS=""
          EXTRA_LIBS=""
          PKGCFG='--pkg-config-flags="--static"'

          if [[ "${RUNNER_OS}" == "macOS" ]]; then
            # На macOS pkg-config часто не видит Homebrew-префиксы без явного PKG_CONFIG_PATH,
            # особенно на arm64 (/opt/homebrew).
            BREW_PREFIX="$(brew --prefix)"
            OPENSSL_PREFIX="$(brew --prefix openssl@3)"

            export PKG_CONFIG_PATH="${BREW_PREFIX}/lib/pkgconfig:${BREW_PREFIX}/share/pkgconfig:${OPENSSL_PREFIX}/lib/pkgconfig:${PKG_CONFIG_PATH:-}"

            # Для openssl headers/libs (если когда-то добавите --enable-openssl обратно)
            EXTRA_CFLAGS="-I${OPENSSL_PREFIX}/include"
            EXTRA_LDFLAGS="-L${OPENSSL_PREFIX}/lib"

            # На macOS --static через pkg-config часто ломает поиск/линковку brew-библиотек
            PKGCFG=""
          fi

          ./configure \
            $FFMPEG_CONFIG_FLAGS \
            --disable-shared \
            --enable-static \
            ${PKGCFG} \
            --extra-cflags="${EXTRA_CFLAGS}" \
            --extra-ldflags="${EXTRA_LDFLAGS}" \
            --extra-libs="${EXTRA_LIBS}"

          echo "---- configure OK ----"
          tail -n 80 ffbuild/config.log || tail -n 80 config.log || true

      - name: Configure (Windows / MSYS2)
        if: runner.os == 'Windows'
        shell: msys2 {0}
        run: |
          set -euo pipefail
          cd FFmpeg

          ./configure \
            $FFMPEG_CONFIG_FLAGS \
            --disable-shared \
            --enable-static \
            --pkg-config-flags="--static"

          echo "---- configure OK ----"
          tail -n 50 config.log || true

      - name: Build (Linux/macOS)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          set -euo pipefail
          cd FFmpeg
          make -j"$(nproc 2>/dev/null || sysctl -n hw.ncpu)"
          ./ffmpeg -version
          ./ffprobe -version

      - name: Build (Windows / MSYS2)
        if: runner.os == 'Windows'
        shell: msys2 {0}
        run: |
          set -euo pipefail
          cd FFmpeg
          make -j"$(nproc)"
          ./ffmpeg.exe -version
          ./ffprobe.exe -version

      # ---------- strip ----------
      - name: Strip (Linux/macOS)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          set -euo pipefail
          cd FFmpeg
          strip ffmpeg ffprobe || true

      - name: Strip (Windows / MSYS2)
        if: runner.os == 'Windows'
        shell: msys2 {0}
        run: |
          set -euo pipefail
          cd FFmpeg
          x86_64-w64-mingw32-strip ffmpeg.exe ffprobe.exe || true

      # ---------- package ----------
      - name: Package (Linux/macOS)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p dist

          cp -f "FFmpeg/ffmpeg"  "dist/ffmpeg-${{ matrix.target }}"
          cp -f "FFmpeg/ffprobe" "dist/ffprobe-${{ matrix.target }}"
          chmod +x "dist/ffmpeg-${{ matrix.target }}" "dist/ffprobe-${{ matrix.target }}"

          if command -v sha256sum >/dev/null 2>&1; then
            (cd dist && sha256sum "ffmpeg-${{ matrix.target }}"  > "ffmpeg-${{ matrix.target }}.sha256")
            (cd dist && sha256sum "ffprobe-${{ matrix.target }}" > "ffprobe-${{ matrix.target }}.sha256")
          else
            (cd dist && shasum -a 256 "ffmpeg-${{ matrix.target }}"  > "ffmpeg-${{ matrix.target }}.sha256")
            (cd dist && shasum -a 256 "ffprobe-${{ matrix.target }}" > "ffprobe-${{ matrix.target }}.sha256")
          fi

          (cd dist && zip -9 "ffmpeg-${{ matrix.target }}.zip" \
            "ffmpeg-${{ matrix.target }}" \
            "ffprobe-${{ matrix.target }}" \
            "ffmpeg-${{ matrix.target }}.sha256" \
            "ffprobe-${{ matrix.target }}.sha256")

      # ВАЖНО: рекурсивно собираем DLL (включая транзитивные зависимости)
      - name: Collect runtime DLLs (Windows, recursive)
        if: runner.os == 'Windows'
        shell: msys2 {0}
        run: |
          set -euo pipefail
          mkdir -p dist
          cp -f "FFmpeg/ffmpeg.exe"  "dist/ffmpeg-${{ matrix.target }}.exe"
          cp -f "FFmpeg/ffprobe.exe" "dist/ffprobe-${{ matrix.target }}.exe"

          deps_of() {
            objdump -p "$1" 2>/dev/null | awk '/DLL Name/ {print $3}' | sort -u
          }

          : > dist/dlls.todo.txt
          deps_of "dist/ffmpeg-${{ matrix.target }}.exe"  >> dist/dlls.todo.txt
          deps_of "dist/ffprobe-${{ matrix.target }}.exe" >> dist/dlls.todo.txt
          sort -u dist/dlls.todo.txt -o dist/dlls.todo.txt

          : > dist/dlls.done.txt
          changed=1
          while [ "$changed" -eq 1 ]; do
            changed=0

            while read -r dll; do
              [ -z "$dll" ] && continue
              grep -qi "^${dll}$" dist/dlls.done.txt && continue

              echo "$dll" >> dist/dlls.done.txt

              if [ -f "/mingw64/bin/${dll}" ]; then
                cp -f "/mingw64/bin/${dll}" dist/ || true
                deps_of "/mingw64/bin/${dll}" >> dist/dlls.todo.txt
                changed=1
              fi
            done < dist/dlls.todo.txt

            sort -u dist/dlls.todo.txt -o dist/dlls.todo.txt
            sort -u dist/dlls.done.txt -o dist/dlls.done.txt
          done

          echo "Packed DLL count:"
          ls -1 dist/*.dll 2>/dev/null | wc -l || true

      - name: Package (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"

          & ".\dist\ffmpeg-${{ matrix.target }}.exe" -version
          & ".\dist\ffprobe-${{ matrix.target }}.exe" -version

          $files = Get-ChildItem -Path dist -File | Where-Object { $_.Extension -ne ".zip" }
          foreach ($f in $files) {
            $hash = (Get-FileHash -Algorithm SHA256 $f.FullName).Hash.ToLower()
            "$hash  $($f.Name)" | Out-File -Encoding ascii -Append "dist\SHA256SUMS.txt"
          }

          $zipPath = "dist\ffmpeg-${{ matrix.target }}.zip"
          if (Test-Path $zipPath) { Remove-Item -Force $zipPath }
          Compress-Archive -Path "dist\*" -DestinationPath $zipPath -Force

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ffmpeg-${{ matrix.target }}
          path: dist/ffmpeg-${{ matrix.target }}.zip
          if-no-files-found: error
          retention-days: 14

  release:
    name: Publish release assets
    needs: build
    runs-on: ubuntu-latest

    steps:
      - uses: actions/download-artifact@v4

      - name: Create / update release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ffmpeg-binaries
          name: FFmpeg prebuilt binaries
          prerelease: false
          make_latest: false
          fail_on_unmatched_files: true
          files: |
            ffmpeg-*/ffmpeg-*.zip
