name: build-ffmpeg-default

on:
  workflow_dispatch:
    inputs:
      ffmpeg_ref:
        description: "Git ref/tag/branch for FFmpeg (e.g. n7.1.1, release/7.1, master)"
        required: false
        default: "master"

jobs:
  build:
    name: ${{ matrix.name }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux native
          - name: linux-x86_64
            runner: ubuntu-latest
            target: linux
            arch: x86_64
            cross: false

          - name: linux-arm64
            runner: ubuntu-24.04-arm64
            target: linux
            arch: arm64
            cross: false

          # macOS native
          - name: macos-x86_64
            runner: macos-15-intel
            target: macos
            arch: x86_64
            cross: false

          - name: macos-arm64
            runner: macos-latest
            target: macos
            arch: arm64
            cross: false

          # Windows via cross-compilation (llvm-mingw) on Ubuntu
          - name: windows-x86_64
            runner: ubuntu-latest
            target: windows
            arch: x86_64
            cross: true

          - name: windows-arm64
            runner: ubuntu-latest
            target: windows
            arch: arm64
            cross: true

    runs-on: ${{ matrix.runner }}

    env:
      # Pin llvm-mingw tag; update if you need newer toolchain
      LLVM_MINGW_TAG: "20251216"
      LLVM_MINGW_BASEURL: "https://github.com/mstorsjo/llvm-mingw/releases/download"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install deps (Ubuntu)
        if: runner.os == 'Linux'
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            build-essential \
            pkg-config \
            yasm \
            nasm \
            autoconf \
            automake \
            libtool \
            cmake \
            git \
            curl \
            xz-utils \
            ca-certificates

      - name: Install deps (macOS)
        if: runner.os == 'macOS'
        run: |
          set -euo pipefail
          brew update
          brew install pkg-config yasm nasm

      - name: Fetch FFmpeg source
        run: |
          set -euo pipefail
          rm -rf ffmpeg
          git clone --depth 1 --branch "${{ inputs.ffmpeg_ref }}" https://git.ffmpeg.org/ffmpeg.git ffmpeg

      - name: Setup llvm-mingw (for Windows cross)
        if: matrix.cross == true
        run: |
          set -euo pipefail
          TARBALL="llvm-mingw-${LLVM_MINGW_TAG}-ucrt-ubuntu-22.04-x86_64.tar.xz"
          URL="${LLVM_MINGW_BASEURL}/${LLVM_MINGW_TAG}/${TARBALL}"

          echo "Downloading: ${URL}"
          curl -L --retry 5 --retry-delay 2 -o "${TARBALL}" "${URL}"

          rm -rf llvm-mingw
          mkdir -p llvm-mingw
          tar -xJf "${TARBALL}" -C llvm-mingw --strip-components=1

          echo "${PWD}/llvm-mingw/bin" >> "${GITHUB_PATH}"

          # Quick sanity check (safe under pipefail)
          echo "Toolchain bin dir:"
          find llvm-mingw/bin -maxdepth 1 -type f -o -type l | sort | head -n 50

      - name: Configure (default) + Build + Install (native)
        if: matrix.cross == false
        run: |
          set -euo pipefail
          cd ffmpeg

          mkdir -p "${GITHUB_WORKSPACE}/dist"

          ./configure --prefix="${GITHUB_WORKSPACE}/dist"
          make -j"$(getconf _NPROCESSORS_ONLN)"
          make install

      - name: Configure (default) + Build + Install (Windows cross)
        if: matrix.cross == true
        run: |
          set -euo pipefail
          cd ffmpeg

          mkdir -p "${GITHUB_WORKSPACE}/dist"

          if [ "${{ matrix.arch }}" = "x86_64" ]; then
            HOST_TRIPLE="x86_64-w64-mingw32"
            FFMPEG_ARCH="x86_64"
          elif [ "${{ matrix.arch }}" = "arm64" ]; then
            HOST_TRIPLE="aarch64-w64-mingw32"
            FFMPEG_ARCH="aarch64"
          else
            echo "Unsupported arch: ${{ matrix.arch }}"
            exit 1
          fi

          export CC="${HOST_TRIPLE}-clang"
          export CXX="${HOST_TRIPLE}-clang++"
          export AR="${HOST_TRIPLE}-ar"
          export RANLIB="${HOST_TRIPLE}-ranlib"
          export STRIP="${HOST_TRIPLE}-strip"
          export NM="${HOST_TRIPLE}-nm"

          ./configure \
            --prefix="${GITHUB_WORKSPACE}/dist" \
            --target-os=mingw32 \
            --arch="${FFMPEG_ARCH}" \
            --enable-cross-compile \
            --cc="${CC}" \
            --cxx="${CXX}" \
            --ar="${AR}" \
            --ranlib="${RANLIB}" \
            --strip="${STRIP}" \
            --nm="${NM}"

          make -j"$(getconf _NPROCESSORS_ONLN)"
          make install

      - name: Package artifact
        shell: bash
        run: |
          set -euo pipefail
          ARTIFACT="ffmpeg-${{ matrix.target }}-${{ matrix.arch }}"
          mkdir -p out

          # Pack dist/ as tar.gz (works for all targets; Windows users can unpack with 7-Zip)
          tar -czf "out/${ARTIFACT}.tar.gz" -C dist .

          echo "Created out/${ARTIFACT}.tar.gz"
          ls -la out

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ffmpeg-${{ matrix.target }}-${{ matrix.arch }}
          path: out/*.tar.gz
          if-no-files-found: error
